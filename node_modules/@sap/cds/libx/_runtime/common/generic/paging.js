const cds = require('../../cds')
const { getDefaultPageSize, getMaxPageSize } = require('../utils/page')

const commonGenericPaging = function (req) {
  // only if http request
  if (!(req.http?.req || req._.req)) return

  // target === null if view with parameters
  if (!req.target || !req.query.SELECT || req.query.SELECT.one) return

  _addPaging(req.query, req.target)
}

const _addPaging = function (query, target) {
  let { rows, offset } = query.SELECT.limit || {}
  rows = rows && 'val' in rows ? rows.val : getDefaultPageSize(target)
  offset = offset && 'val' in offset ? offset.val : 0
  query.limit(...[Math.min(rows, getMaxPageSize(target)), offset])
  //Handle nested limits
  if (query.SELECT.from.SELECT) _addPaging(query.SELECT.from, target)
}

/**
 * handler registration
 */
module.exports = cds.service.impl(function () {
  commonGenericPaging._initial = true
  this.before('READ', '*', commonGenericPaging)
})
